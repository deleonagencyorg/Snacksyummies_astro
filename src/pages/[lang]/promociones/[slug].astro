---
// src/pages/[lang]/promociones/[slug].astro
import { setLocale, t, type Locale } from '../../../i18n/i18n';
import MainLayout from '../../../layouts/MainLayout.astro';
import SEO from '../../../components/SEO.astro';
import PromotionDetailView from '../../../views/Promotions/Detail/index.astro';

export async function getStaticPaths() {
  // Obtener todas las promociones disponibles para ambos idiomas
  const esPromotionsData = t('promotions', { namespace: 'promotions', locale: 'es' }) || [];
  const enPromotionsData = t('promotions', { namespace: 'promotions', locale: 'en' }) || [];
  
  const esPaths = esPromotionsData.map((promotion: any) => ({
    params: { 
      lang: 'es',
      slug: promotion.slug 
    },
    props: { 
      promotionSlug: promotion.slug,
      promotionTitle: promotion.title
    }
  }));
  
  const enPaths = enPromotionsData.map((promotion: any) => ({
    params: { 
      lang: 'en',
      slug: promotion.slug 
    },
    props: { 
      promotionSlug: promotion.slug,
      promotionTitle: promotion.title
    }
  }));
  
  return [...esPaths, ...enPaths];
}

const { lang, slug } = Astro.params as { lang: Locale; slug: string };
const { promotionSlug, promotionTitle } = Astro.props;

setLocale(lang);

// Obtener datos de la promoción para metadatos
const promotionsData = t('promotions', { namespace: 'promotions', locale: lang }) || [];
const promotion = promotionsData.find((p: any) => p.slug === promotionSlug);

if (!promotion) {
  return Astro.redirect(`/${lang}/404`);
}

// Metadatos dinámicos
const metaTitle = `${promotion.title} - ${t('meta.promotions.title', { namespace: 'common', locale: lang })}`;
const metaDescription = promotion.subtitle || t('meta.promotions.description', { namespace: 'common', locale: lang });
const metaImage = promotion?.image?.desktop || promotion?.image?.mobile || '';

<MainLayout title={metaTitle} description={metaDescription}>
  <SEO 
    slot="head"
    currentLang={lang}
    title={metaTitle}
    description={metaDescription}
    canonicalUrl={`https://snacksyummies.com/${lang}/promociones/${promotionSlug}`}
    imageUrl={metaImage}
  />
  <PromotionDetailView currentLang={lang} promotionSlug={promotionSlug} />
</MainLayout>
