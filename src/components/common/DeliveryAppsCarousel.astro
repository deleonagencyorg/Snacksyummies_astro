---
// src/components/common/DeliveryAppsCarousel.astro
import { getLocale, t } from '../../i18n/i18n';

interface AppItem {
  app_icon: string;
  app_name: string;
  app_url: string;
  country?: string;
}

interface Props {
  title?: string;
  subtitle?: string;
  items?: AppItem[];
}

const currentLang = getLocale();
const {
  title = currentLang === 'es' ? 'Encuéntralos en tiendas y en línea:' : 'Find them in stores and online:',
  subtitle = '',
  items = (t('home.delivery.delivery_apps', { namespace: 'common', locale: 'es' }) as unknown as AppItem[]) || [],
}: Props = Astro.props;

// Only render for Spanish as requested
const shouldRender = currentLang === 'es' && Array.isArray(items) && items.length > 0;
---

{shouldRender && (
  <section class="delivery-apps-section content-stretch w-full bg-white">
    <div class="container mx-auto px-4 py-10">
      <h3 class="text-primary text-center font-title font-bold text-2xl md:text-3xl mb-6">
        {title}
      </h3>

      <div class="relative max-w-6xl mx-auto" id="apps-carousel-wrapper">
        <button class="apps-nav left hidden" type="button" aria-label="Anterior" data-dir="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <button class="apps-nav right hidden" type="button" aria-label="Siguiente" data-dir="1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </button>

        <!-- JSON data para geo-detection (set:html evita escaping de comillas) -->
        <script id="carousel-apps-data" type="application/json" set:html={JSON.stringify(items)}></script>

        <!-- Contenedor dinámico: oculto hasta que geo-detection lo rellene -->
        <div id="apps-track" class="apps-track centered" data-small="1">
        </div>
      </div>
    </div>
  </section>
)}

<style>
  .delivery-apps-section { overflow: hidden; }
  .apps-track {
    display: flex;
    gap: 2rem;
    overflow-x: auto;
    scroll-behavior: smooth;
    padding: 0.75rem 3.25rem; /* room for larger arrows */
  }
  .apps-track.centered {
    justify-content: center;
    overflow: visible;
    padding: 0.5rem 0;
  }
  .apps-track::-webkit-scrollbar { display: none; }
  .apps-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    background: white;
    color: #0A3D7E; /* primary */
    width: 3.25rem;
    height: 3.25rem;
    border-radius: 9999px;
    display: grid;
    place-items: center;
    box-shadow: 0 8px 25px -5px rgba(0,0,0,0.15);
  }
  .apps-nav.left { left: 0; }
  .apps-nav.right { right: 0; }
  @media (max-width: 768px) { .apps-nav { display: none; } }

  .app-pill {
    flex: 0 0 auto;
    width: 112px; height: 112px;
    border-radius: 9999px;
    display: grid; place-items: center;
    background: #ffffff;
    border: 2px solid rgba(10,61,126,0.15);
    transition: transform .25s ease, box-shadow .25s ease;
  }
  .app-pill:hover { transform: translateY(-4px) scale(1.03); box-shadow: 0 8px 24px -8px rgba(10,61,126,0.3); }
  .app-icon { width: 96px; height: 96px; object-fit: contain; border-radius: 9999px; }
</style>

<script is:inline>
  (function () {
    const COUNTRY_MAPPINGS = {
      'HN': 'Honduras',
      'GT': 'Guatemala',
      'SV': 'El Salvador',
      'NI': 'Nicaragua',
      'CR': 'Costa Rica',
      'DO': 'República Dominicana'
    };

    const GEO_COOKIE_NAME = 'yummies_geo_v2';
    const GEO_COOKIE_DAYS = 7;

    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
      return match ? decodeURIComponent(match[1]) : null;
    }

    function getGeoCookieValue() {
      return getCookie('yummies_geo_v2') || getCookie('yummies_country_code') || null;
    }

    function setCookie(name, value, days) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/; SameSite=Lax';
    }

    async function resolveCountryCode() {
      const cached = getGeoCookieValue();
      if (cached) return cached;

      try {
        const r = await fetch('/api/geo-headers');
        if (r.ok) { const d = await r.json(); if (d.country) { setCookie(GEO_COOKIE_NAME, d.country, GEO_COOKIE_DAYS); return d.country; } }
      } catch (_) {}

      try {
        const r = await fetch('https://ipapi.co/json/');
        if (r.ok) { const d = await r.json(); if (d.country_code) { setCookie(GEO_COOKIE_NAME, d.country_code, GEO_COOKIE_DAYS); return d.country_code; } }
      } catch (_) {}

      try {
        const r = await fetch('https://api.country.is/');
        if (r.ok) { const d = await r.json(); if (d.country) { setCookie(GEO_COOKIE_NAME, d.country, GEO_COOKIE_DAYS); return d.country; } }
      } catch (_) {}

      setCookie(GEO_COOKIE_NAME, 'HN', GEO_COOKIE_DAYS);
      return 'HN';
    }

    function renderCarousel(countryCode) {
      const track = document.getElementById('apps-track');
      const dataEl = document.getElementById('carousel-apps-data');
      if (!track || !dataEl) return;

      let allApps = [];
      try { allApps = JSON.parse(dataEl.textContent || '[]'); } catch (_) {}
      if (!allApps.length) return;

      const mapped = COUNTRY_MAPPINGS[countryCode];
      const matchedApp = mapped
        ? allApps.find(app => app.country && app.country.toLowerCase() === mapped.toLowerCase())
        : null;

      const appsToShow = matchedApp ? [matchedApp] : allApps;
      const isSmall = appsToShow.length <= 2;

      track.innerHTML = '';
      appsToShow.forEach(app => {
        const a = document.createElement('a');
        a.href = app.app_url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.className = 'app-pill';
        a.setAttribute('aria-label', app.app_name);
        a.title = app.app_name;
        a.innerHTML = `<img src="${app.app_icon}" alt="${app.app_name}" class="app-icon" loading="lazy" />`;
        track.appendChild(a);
      });

      // Centrar si hay 1-2 apps, carrusel si hay más
      if (isSmall) {
        track.className = 'apps-track centered';
        track.setAttribute('data-small', '1');
        document.querySelectorAll('.apps-nav').forEach(btn => btn.classList.add('hidden'));
      } else {
        track.className = 'apps-track';
        track.setAttribute('data-small', '0');
        document.querySelectorAll('.apps-nav').forEach(btn => btn.classList.remove('hidden'));
        initCarouselControls(track);
      }
    }

    function initCarouselControls(track) {
      document.querySelectorAll('.apps-nav').forEach(btn => {
        btn.addEventListener('click', () => {
          const dir = Number(btn.getAttribute('data-dir') || '1');
          track.scrollBy({ left: dir * 240, behavior: 'smooth' });
        });
      });

      let autoplay = null;
      function start() {
        if (autoplay) return;
        autoplay = window.setInterval(() => { track.scrollBy({ left: 160, behavior: 'smooth' }); }, 3000);
      }
      function stop() { if (autoplay) { window.clearInterval(autoplay); autoplay = null; } }
      track.addEventListener('mouseenter', stop);
      track.addEventListener('mouseleave', start);
      start();
    }

    async function initCarousel() {
      if (!document.getElementById('apps-track')) return;
      const cached = getGeoCookieValue();
      if (cached) {
        renderCarousel(cached);
      } else {
        const code = await resolveCountryCode();
        renderCarousel(code);
      }
    }

    // Ejecutar inmediatamente (is:inline, elementos ya en DOM)
    initCarousel();

    // View Transitions: registrar solo una vez
    if (!window.__carouselPageLoadRegistered) {
      window.__carouselPageLoadRegistered = true;
      document.addEventListener('astro:page-load', initCarousel);
      document.addEventListener('astro:after-swap', initCarousel);
    }
  })();
</script>
