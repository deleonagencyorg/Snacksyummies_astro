---
import CarouselSlide from '../CarouselSlide.astro';
import Skeleton from './Skeleton.astro';
import './styles.css';

export interface Props {
  slides: Array<{
    desktop: string;
    mobile: string;
    alt: string;
    title: string;
    subtitle: string;
    link?: string;
  }>;
  loading?: boolean;
}

const { slides = [], loading = false } = Astro.props;
const slideCount = Array.isArray(slides) ? slides.length : 0;
const showControls = slideCount > 1;
const safeSlides = slideCount > 0
  ? slides
  : [
      {
        desktop: 'https://snack.yummiespromociones.com/SnacksyummiesAssets/placeholder.webp',
        mobile: 'https://snack.yummiespromociones.com/SnacksyummiesAssets/placeholder.webp',
        alt: 'Snacks Yummies',
        title: '',
        subtitle: '',
        link: ''
      }
    ];

// Log de depuración


// Identificar la primera imagen para cargarla con prioridad
const firstSlide = safeSlides[0] || {};

// Log del primer slide


// Opcional: Precargar la primera imagen para mejorar el LCP
const preloadFirstImage = true && firstSlide.mobile && firstSlide.desktop;

---

<!-- Importar Swiper desde CDN para garantizar disponibilidad -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
<script is:inline src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

<!-- Cargar scripts del carrusel solo en el cliente -->
<script is:inline define:vars={{ carouselSelector: '.swiper-container.main-carousel', slideCount, showControls }}>
  // Variable global para almacenar la instancia de Swiper
  window.mainCarouselInstance = window.mainCarouselInstance || null;
  
  function initMainCarousel() {
    // Destruir instancia previa si existe
    if (window.mainCarouselInstance && typeof window.mainCarouselInstance.destroy === 'function') {
      try {
        window.mainCarouselInstance.destroy(true, true);
        window.mainCarouselInstance = null;
      } catch (e) {
        console.warn('Error al destruir Swiper previo:', e);
      }
    }
    
    // Esperar a que el DOM esté listo y Swiper esté disponible
    const attemptInit = () => {
      if (typeof Swiper === 'undefined') {
        // Swiper aún no está cargado, reintentar
        setTimeout(attemptInit, 100);
        return;
      }
      
      const container = document.querySelector(carouselSelector);
      if (!container) {
        console.warn('Contenedor del carrusel no encontrado');
        return;
      }
      
      try {
        // Ocultar controles si no son necesarios
        if (!showControls) {
          const nextBtn = container.querySelector('.swiper-button-next');
          const prevBtn = container.querySelector('.swiper-button-prev');
          const pagination = container.querySelector('.swiper-pagination');
          if (nextBtn) nextBtn.style.display = 'none';
          if (prevBtn) prevBtn.style.display = 'none';
          if (pagination) pagination.style.display = 'none';
        }
        
        // Configuración de Swiper
        const swiperConfig = {
          loop: showControls,
          autoplay: showControls ? {
            delay: 5000,
            disableOnInteraction: false,
            pauseOnMouseEnter: false,
          } : false,
          navigation: showControls ? {
            nextEl: `${carouselSelector} .swiper-button-next`,
            prevEl: `${carouselSelector} .swiper-button-prev`,
          } : false,
          pagination: showControls ? {
            el: `${carouselSelector} .swiper-pagination`,
            clickable: true,
          } : false,
          touchRatio: 1.5,
          touchAngle: 45,
          touchMoveStopPropagation: true,
          touchStartPreventDefault: false,
          touchStartForcePreventDefault: false,
          threshold: 5,
          speed: 600,
          preventClicks: false,
          preventClicksPropagation: false,
          observer: true,
          observeParents: true,
          on: {}
        };
        
        // Inicializar Swiper
        window.mainCarouselInstance = new Swiper(carouselSelector, swiperConfig);
        
        // Actualizar al cambiar orientación
        const handleOrientationChange = () => {
          setTimeout(() => {
            if (window.mainCarouselInstance && typeof window.mainCarouselInstance.update === 'function') {
              window.mainCarouselInstance.update();
            }
          }, 200);
        };
        
        window.removeEventListener('orientationchange', handleOrientationChange);
        window.addEventListener('orientationchange', handleOrientationChange);
        
      } catch (error) {
        console.error('❌ Error al inicializar Swiper:', error);
      }
    };
    
    // Iniciar con un pequeño delay para asegurar que el DOM esté completamente listo
    setTimeout(attemptInit, 300);
  }
  
  // Inicializar en carga inicial
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMainCarousel);
  } else {
    initMainCarousel();
  }
  
  // Reinicializar en navegaciones de Astro (cambio de idioma)
  document.addEventListener('astro:page-load', initMainCarousel);
  document.addEventListener('astro:after-swap', initMainCarousel);
</script>

{loading ? (
  <Skeleton items={3} />
) : (
  <div class="relative overflow-hidden w-screen" transition:animate="fade">
    {preloadFirstImage && (
      <>
        <!-- Precargar la primera imagen para dispositivos móviles -->
        <link rel="preload" href={firstSlide.mobile} as="image" media="(max-width: 767px)">
        <!-- Precargar la primera imagen para escritorio -->
        <link rel="preload" href={firstSlide.desktop} as="image" media="(min-width: 768px)">
      </>
    )}
    
    <!-- Swiper container -->
    <div class="swiper-container main-carousel">
      <div class="swiper-wrapper">
        {safeSlides.map((slide, index) => (
          <CarouselSlide 
            slide={{
              desktop: slide.desktop,
              mobile: slide.mobile,
              alt: slide.alt || 'Snacks Yummies',
              title: slide.title || '',
              subtitle: slide.subtitle || '',
              link: slide.link || ''
            }}
            priority={index === 0}
          />
        ))}
      </div>
      
      <!-- Controles de navegación -->
      {showControls && <div class="swiper-button-next"></div>}
      {showControls && <div class="swiper-button-prev"></div>}
      {showControls && <div class="swiper-pagination"></div>}
    </div>
  </div>
)}
