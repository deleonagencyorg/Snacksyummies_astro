---
// src/components/common/Footer/index.astro
import { t, type Locale } from '../../../i18n/i18n';
import { logos, generalAssets } from '../../../config/assets';
import './styles.css';
import Skeleton from './Skeleton.astro';
import LazyImage from '../LazyImage.astro';
import Newsletter from '../Newsletter/index.astro';
import SocialMediaIcons from '../SocialMediaIcons/index.astro';
import contactEs from '../../../locales/es/contact.json';
import contactEn from '../../../locales/en/contact.json';

export interface Props {
  currentLang: Locale;
  loading?: boolean;
}

const { currentLang, loading = false } = Astro.props;

const currentYear = new Date().getFullYear();

// Obtener textos del footer desde los archivos de traducciÃ³n
const privacyPolicyText = t('footer.privacy_policy_text', { namespace: 'common', locale: currentLang });
const privacyPolicyUrl = t('footer.privacy_policy_url', { namespace: 'common', locale: currentLang });
const copyrightText = t('footer.copyright', { namespace: 'common', locale: currentLang }).replace('{year}', currentYear.toString());
const address = t('footer.address', { namespace: 'common', locale: currentLang });
const phone = t('footer.phone', { namespace: 'common', locale: currentLang });
const hours = t('footer.hours', { namespace: 'common', locale: currentLang });
const newsletterTitle = t('footer.newsletter_title', { namespace: 'common', locale: currentLang });
const newsletterPlaceholder = t('footer.newsletter_placeholder', { namespace: 'common', locale: currentLang });
const newsletterButton = t('footer.newsletter_button', { namespace: 'common', locale: currentLang });

// Datos de oficinas por paÃ­s para detecciÃ³n geo
const contactData = currentLang === 'en' ? contactEn : contactEs;
const officesData = contactData.offices.locations;
---

{loading ? (
  <Skeleton />
) : (
  <footer class="bg-cuaternary text-white py-8 px-4 sm:px-6 lg:px-8 font-sans">
    <div class="container mx-auto">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
        <!-- Orden de columnas en mobile controlado con order-* -->
        <!-- Columna 1: InformaciÃ³n de contacto (segundo en mobile) -->
        <div class="flex flex-col items-start md:items-start items-center space-y-4 order-2 md:order-1">
          <div class="flex items-center md:items-start space-x-2 justify-center md:justify-start">
            <LazyImage
              src={generalAssets.locationIcon}
              alt="UbicaciÃ³n"
              class="h-5 w-5 flex-shrink-0 mt-0.5"
              color="white"
              width={20}
              height={20}
            />
            <span id="footer-address">{address}</span>
          </div>
          <div class="flex items-center space-x-2 justify-center md:justify-start">
            <LazyImage
              src={generalAssets.phoneIcon}
              alt="TelÃ©fono"
              class="h-5 w-5 flex-shrink-0"
              color="white"
              width={20}
              height={20}
            />
            <span id="footer-phone">{phone}</span>
          </div>
          <div class="flex items-center space-x-2 justify-center md:justify-start">
            <LazyImage
              src={generalAssets.timeIcon}
              alt="Horario"
              class="h-5 w-5 flex-shrink-0"
              color="white"
              width={20}
              height={20}
            />
            <span>{hours}</span>
          </div>
        </div>

        <!-- Columna 2: Logo, polÃ­tica de privacidad y copyright (tercero en mobile) -->
        <div class="flex flex-col items-center space-y-4 order-3 md:order-2">
          <a href={`/${currentLang}/`} class="mb-2">
            <img src={logos.principal.url} alt={logos.principal.alt || 'Yummies Logo'} class="h-16 w-auto mx-auto" />
          </a>
          <div>
            <a href={privacyPolicyUrl} class="text-sm hover:underline">{privacyPolicyText}</a>
          </div>
          <div class="text-xs opacity-80">
            {copyrightText}
          </div>
        </div>

        <!-- Columna 3: Newsletter y redes sociales (primero en mobile) -->
        <div class="flex flex-col items-center md:items-start w-full order-1 md:order-3">
          <!-- Redes Sociales -->
          <div class="mb-4">
            <SocialMediaIcons 
              currentLang={currentLang} 
              iconColor="white"
              centered={false} 
            />
          </div>
          <!-- Newsletter -->
          <Newsletter 
            title={newsletterTitle}
            placeholder={newsletterPlaceholder} 
            buttonText={newsletterButton}
            centered={false}
          />
        </div>
      </div>
      
      <!-- Separador para la secciÃ³n de contacto DINANT -->
      <div class="w-full border-t border-white border-opacity-20 mt-6 pt-6">
        <div class="container mx-auto">
          <div class="text-center mb-4">
            <h3 class="text-white  font-sans text-xl font-medium">DINANT - Contacto</h3>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4 justify-items-center">
            <!-- Guatemala -->
            <div class="flex items-center space-x-2">
              <span class="text-2xl" role="img" aria-label="Guatemala">ðŸ‡¬ðŸ‡¹</span>
              <span>(+502) 2502-7050</span>
            </div>
            <!-- El Salvador -->
            <div class="flex items-center space-x-2">
              <span class="text-2xl" role="img" aria-label="El Salvador">ðŸ‡¸ðŸ‡»</span>
              <span>(+503) 2510-8300</span>
            </div>
            <!-- Costa Rica -->
            <div class="flex items-center space-x-2">
              <span class="text-2xl" role="img" aria-label="Costa Rica">ðŸ‡¨ðŸ‡·</span>
              <span>(+506) 2271-0665</span>
            </div>
            <!-- RepÃºblica Dominicana -->
            <div class="flex items-center space-x-2">
              <span class="text-2xl" role="img" aria-label="RepÃºblica Dominicana">ðŸ‡©ðŸ‡´</span>
              <span>(+001) 809-2731042</span>
            </div>
            <!-- Nicaragua -->
            <div class="flex items-center space-x-2">
              <span class="text-2xl" role="img" aria-label="Nicaragua">ðŸ‡³ðŸ‡®</span>
              <span>(+505) 2255-7480</span>
            </div>
            <!-- Honduras -->
            <div class="flex items-center space-x-2">
              <span class="text-2xl" role="img" aria-label="Honduras">ðŸ‡­ðŸ‡³</span>
              <span>(+504) 2275-3370</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </footer>
)}

<script src="./scripts.js"></script>

<script define:vars={{ officesData }}>
  const COUNTRY_CODE_TO_OFFICE_KEY = {
    'HN': '+504',
    'GT': '+502',
    'SV': '+503',
    'NI': '+505',
    'CR': '+506',
    'DO': '+1809'
  };

  const DEFAULT_OFFICE_KEY = '+504';
  const GEO_COOKIE_NAME = 'yummies_geo_v2';
  const GEO_COOKIE_DAYS = 7;

  function getCookie(name) {
    const match = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
    return match ? decodeURIComponent(match[1]) : null;
  }

  function getGeoCookieValue() {
    return getCookie('yummies_geo_v2') || getCookie('yummies_country_code') || null;
  }

  function setCookie(name, value, days) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/; SameSite=Lax';
  }

  function setLoadingState() {
    const addressEl = document.getElementById('footer-address');
    const phoneEl = document.getElementById('footer-phone');
    if (addressEl) {
      addressEl.innerHTML = '<span class="inline-block bg-white/20 rounded animate-pulse w-48 h-4">&nbsp;</span>';
    }
    if (phoneEl) {
      phoneEl.innerHTML = '<span class="inline-block bg-white/20 rounded animate-pulse w-28 h-4">&nbsp;</span>';
    }
  }

  function updateFooterContact(officeKey) {
    const office = officesData[officeKey] || officesData[DEFAULT_OFFICE_KEY];
    if (!office) return;

    const addressEl = document.getElementById('footer-address');
    const phoneEl = document.getElementById('footer-phone');

    if (addressEl && office.address) {
      addressEl.textContent = office.address;
    }
    if (phoneEl && office.phones && office.phones.length > 0) {
      phoneEl.textContent = office.phones[0];
    }
  }

  async function detectCountryCode() {
    // MÃ©todo 1: API del servidor (Cloudflare headers)
    try {
      const response = await fetch('/api/geo-headers');
      if (response.ok) {
        const data = await response.json();
        if (data.country) return data.country;
      }
    } catch (_) {}

    // MÃ©todo 2: ipapi.co
    try {
      const response = await fetch('https://ipapi.co/json/');
      if (response.ok) {
        const data = await response.json();
        if (data.country_code) return data.country_code;
      }
    } catch (_) {}

    // MÃ©todo 3: api.country.is
    try {
      const response = await fetch('https://api.country.is/');
      if (response.ok) {
        const data = await response.json();
        if (data.country) return data.country;
      }
    } catch (_) {}

    return null;
  }

  async function initFooterGeo() {
    // Mostrar estado de carga inmediatamente
    setLoadingState();

    // Leer cookie primero
    const cached = getGeoCookieValue();
    if (cached) {
      const officeKey = COUNTRY_CODE_TO_OFFICE_KEY[cached] || DEFAULT_OFFICE_KEY;
      updateFooterContact(officeKey);
      return;
    }

    // Detectar paÃ­s via APIs
    const countryCode = await detectCountryCode();

    // Guardar en cookie (incluso si es null guardamos 'HN' para no volver a detectar)
    setCookie(GEO_COOKIE_NAME, countryCode || 'HN', GEO_COOKIE_DAYS);

    const officeKey = countryCode ? (COUNTRY_CODE_TO_OFFICE_KEY[countryCode] || DEFAULT_OFFICE_KEY) : DEFAULT_OFFICE_KEY;
    updateFooterContact(officeKey);
  }

  // Astro View Transitions + fallback DOMContentLoaded
  document.addEventListener('astro:page-load', initFooterGeo);
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFooterGeo);
  } else {
    initFooterGeo();
  }
</script>
