---
import LazyImage from '../common/LazyImage.astro';
import { getLocale } from '../../i18n/i18n';

interface Props {
  image: string;
  title: string;
  id: string;
  brand?: string;
  slug?: string;
  textColor?: string;
  isNew?: boolean;
}

const { 
  image, 
  title, 
  id,
  brand = '',
  slug,
  textColor = 'text-blue-900',
  isNew = false
} = Astro.props;

const currentLocale = getLocale();
const badgeImage = currentLocale === 'es' ? 'https://snack.yummiespromociones.com/SnacksyummiesAssets/NUEVO.webp' : 'https://snack.yummiespromociones.com/SnacksyummiesAssets/NEW.webp';
const badgeAlt = currentLocale === 'es' ? 'Nuevo' : 'New';
const productLink = `/${currentLocale}/${currentLocale === 'es' ? 'productos' : 'products'}/${slug ?? id}`;

// Función para normalizar títulos con acentos
function normalizeTitle(input: string): string {
  if (!input) return '';

  // Primero normalizamos a NFC para unificar caracteres compuestos
  let text = input.normalize('NFC');

  // Método directo para casos específicos
  text = text
    // Vocales minúsculas con acento
    .replace(/Ã¡/g, 'á')
    .replace(/Ã©/g, 'é')
    .replace(/Ã­/g, 'í')
    .replace(/Ã³/g, 'ó')
    .replace(/Ãº/g, 'ú')
    // Vocales mayúsculas con acento
    .replace(/Ã/g, 'Á')
    .replace(/Ã‰/g, 'É')
    .replace(/Ã/g, 'Í')
    .replace(/Ã"/g, 'Ó')
    .replace(/Ãš/g, 'Ú')
    // Ñ y caracteres especiales
    .replace(/Ã±/g, 'ñ')
    .replace(/Ã'/g, 'Ñ')
    .replace(/Â/g, '')
    // Casos específicos observados
    .replace(/manÃ/g, 'maní')
    .replace(/japonÃ©s/g, 'japonés')
    .replace(/PlÃ¡tano/g, 'Plátano')
    .replace(/MaÃ­z/g, 'Maíz')
    .replace(/PÃ¡caros/g, 'Pícaros')
    .replace(/PÃ­caros/g, 'Pícaros')
    .replace(/JalapeÃ±o/g, 'Jalapeño')
    .replace(/ChicharrÃ³n/g, 'Chicharrón')
    .replace(/FusiÃ³n/g, 'Fusión')
    .replace(/ClÃ¡sicas/g, 'Clásicas')
    .replace(/Ã³n/g, 'ón');

  // Limpieza final de espacios y caracteres invisibles
  text = text.replace(/[\u00A0\u200B\u200C\u200D]/g, ' ').trim();

  // Normalizar nuevamente para asegurar consistencia
  return text.normalize('NFC');
}

const safeTitle = normalizeTitle(String(title || ''));
---

<div class="flex flex-col items-center w-full">
  <a href="#" class="w-full flex flex-col items-center">
  <!-- <a href={productLink} class="w-full flex flex-col items-center"> -->
    <div class="w-full flex justify-center">
      <div class="product-image-container overflow-hidden mb-2 hover:scale-105 transition-transform duration-300 flex items-center justify-center flex-shrink-0">
        <LazyImage
          src={image}
          alt={safeTitle}
          width="200"
          height="200"
          class="product-image object-contain"
          transition:name={`product-image-${id}`}
        />
        {isNew && (
          <img 
            src={badgeImage}
            alt={badgeAlt}
            class="product-new-badge-grid"
            loading="eager"
          />
        )}
      </div>
    </div>
    
    <h3 class="text-center font-title text-sm sm:text-base leading-tight text-primary">
      {safeTitle}
    </h3>
  </a>
</div>

<style>
  .product-image-container {
    width: 200px;
    height: 200px;
    min-width: 200px;
    min-height: 200px;
    position: relative;
  }

  .product-image-container :global(.product-image) {
    width: 200px !important;
    height: 200px !important;
    max-width: 200px;
    max-height: 200px;
    object-fit: contain;
    aspect-ratio: 1 / 1;
  }

  .product-new-badge-grid {
    position: absolute;
    top: 5%;
    right: 5%;
    width: 70px;
    height: 70px;
    object-fit: contain;
    z-index: 10;
    pointer-events: none;
    filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.4));
    animation: pulse-badge 2s ease-in-out infinite;
  }

  @keyframes pulse-badge {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
  }

  @media (max-width: 640px) {
    .product-new-badge-grid {
      width: 55px;
      height: 55px;
    }
  }

  @media (min-width: 641px) and (max-width: 1024px) {
    .product-new-badge-grid {
      width: 65px;
      height: 65px;
    }
  }
</style>
