---
import { t, type Locale } from '../../../i18n/i18n';

interface Props {
  currentLang: Locale;
}

interface Message {
  title: string;
  link?: string;
}

const { currentLang } = Astro.props;

// Obtener los mensajes del archivo de traducción
const messages = t('messagetop', { namespace: 'common', locale: currentLang }) as Message[] || [];
const messageCount = Array.isArray(messages) ? messages.length : 0;
const showControls = messageCount > 1;
const safeMessages = messageCount > 0 ? messages : [{ title: '' }];

---

<div id="message-carousel" class="w-full bg-tertiary text-white py-8 md:py-4  relative overflow-hidden z-10">
  <div class="container mx-auto px-4">
    <div class="message-slider flex items-center justify-center min-h-[1.5rem] md:min-h-[2rem] relative">
      {safeMessages.map((message: Message, index: number) => (
        <div class="message-slide absolute w-full text-center transition-all duration-700 transform" 
             data-index={index} 
             style={index === 0 ? "opacity: 1; transform: translateY(0)" : "opacity: 0; transform: translateY(20px)"}>
          {message.link ? (
            <a href={message.link} class="text-white hover:underline text-sm md:text-lg font-medium">
              {message.title}
            </a>
          ) : (
            <span class="text-sm md:text-lg font-medium">{message.title}</span>
          )}
        </div>
      ))}
    </div>
  </div>
  {showControls && (
    <div class="absolute top-0 bottom-0 left-2 md:left-4 flex items-center z-20">
      <button id="prev-message" class="text-white p-2 md:p-1 hover:bg-white hover:bg-opacity-20 rounded-full transition-all duration-300 touch-manipulation active:scale-95" aria-label="Mensaje anterior">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-5 md:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
    </div>
  )}
  {showControls && (
    <div class="absolute top-0 bottom-0 right-2 md:right-4 flex items-center z-20">
      <button id="next-message" class="text-white p-2 md:p-1 hover:bg-white hover:bg-opacity-20 rounded-full transition-all duration-300 touch-manipulation active:scale-95" aria-label="Siguiente mensaje">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-5 md:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  )}
</div>

<script>
  // Variables globales para gestionar el carrusel
  window.messageCarouselState = window.messageCarouselState || {
    interval: null,
    currentSlide: 0,
    isInitialized: false,
    prevClickHandler: null,
    nextClickHandler: null
  };

  function initMessageCarousel() {
    // Limpiar estado anterior
    if (window.messageCarouselState.interval) {
      clearInterval(window.messageCarouselState.interval);
      window.messageCarouselState.interval = null;
    }

    // Esperar a que el DOM esté completamente listo
    const attemptInit = () => {
      const slides = document.querySelectorAll('.message-slide');
      const prevButton = document.getElementById('prev-message');
      const nextButton = document.getElementById('next-message');
      
      if (!slides.length) {
        console.warn('⚠️ No se encontraron slides del carrusel de mensajes');
        return;
      }

      const totalSlides = slides.length;
      
      // Si solo hay un slide, ocultar controles
      if (totalSlides <= 1) {
        if (prevButton) prevButton.style.display = 'none';
        if (nextButton) nextButton.style.display = 'none';
        return;
      }

      // Remover event listeners anteriores si existen
      if (prevButton && window.messageCarouselState.prevClickHandler) {
        prevButton.removeEventListener('click', window.messageCarouselState.prevClickHandler);
      }
      if (nextButton && window.messageCarouselState.nextClickHandler) {
        nextButton.removeEventListener('click', window.messageCarouselState.nextClickHandler);
      }

      // Función para mostrar slide
      function showSlide(index) {
        slides.forEach((slide, i) => {
          const slideElement = slide;
          if (i === index) {
            slideElement.style.opacity = '1';
            slideElement.style.transform = 'translateY(0)';
            slideElement.style.zIndex = '1';
            slideElement.classList.add('active-slide');
          } else {
            slideElement.style.opacity = '0';
            slideElement.style.transform = 'translateY(20px)';
            slideElement.style.zIndex = '0';
            slideElement.classList.remove('active-slide');
          }
        });
        
        // Efecto visual en botones
        if (prevButton && nextButton) {
          prevButton.classList.add('pulse-animation');
          nextButton.classList.add('pulse-animation');
          
          setTimeout(() => {
            if (prevButton && nextButton) {
              prevButton.classList.remove('pulse-animation');
              nextButton.classList.remove('pulse-animation');
            }
          }, 300);
        }
      }
      
      const nextSlide = () => {
        window.messageCarouselState.currentSlide = (window.messageCarouselState.currentSlide + 1) % totalSlides;
        showSlide(window.messageCarouselState.currentSlide);
      };
      
      const prevSlide = () => {
        window.messageCarouselState.currentSlide = (window.messageCarouselState.currentSlide - 1 + totalSlides) % totalSlides;
        showSlide(window.messageCarouselState.currentSlide);
      };
      
      // Iniciar rotación automática
      const startAutoRotation = () => {
        if (window.messageCarouselState.interval) {
          clearInterval(window.messageCarouselState.interval);
        }
        window.messageCarouselState.interval = setInterval(nextSlide, 5000);
      };
      
      // Detener rotación
      const stopAutoRotation = () => {
        if (window.messageCarouselState.interval) {
          clearInterval(window.messageCarouselState.interval);
          window.messageCarouselState.interval = null;
        }
      };
      
      // Reiniciar rotación después de interactuar
      const resetAutoRotation = () => {
        stopAutoRotation();
        startAutoRotation();
      };
      
      // Crear y guardar event handlers
      window.messageCarouselState.prevClickHandler = () => {
        prevSlide();
        resetAutoRotation();
      };
      
      window.messageCarouselState.nextClickHandler = () => {
        nextSlide();
        resetAutoRotation();
      };
      
      // Configurar botones de navegación
      if (prevButton) {
        prevButton.addEventListener('click', window.messageCarouselState.prevClickHandler);
      }
      
      if (nextButton) {
        nextButton.addEventListener('click', window.messageCarouselState.nextClickHandler);
      }
      
      // Mostrar el primer slide
      showSlide(window.messageCarouselState.currentSlide);
      
      // Iniciar rotación automática
      startAutoRotation();
      
      window.messageCarouselState.isInitialized = true;
      console.log('✅ Carrusel de mensajes inicializado correctamente con', totalSlides, 'mensajes');
    };

    // Pequeño delay para asegurar que el DOM esté listo
    setTimeout(attemptInit, 100);
  }

  // Inicializar en carga inicial
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMessageCarousel);
  } else {
    initMessageCarousel();
  }

  // Reinicializar en navegaciones de Astro (cambio de idioma)
  document.addEventListener('astro:page-load', initMessageCarousel);
  document.addEventListener('astro:after-swap', initMessageCarousel);

  // Limpiar cuando se va a cambiar de página
  document.addEventListener('astro:before-preparation', () => {
    if (window.messageCarouselState && window.messageCarouselState.interval) {
      clearInterval(window.messageCarouselState.interval);
      window.messageCarouselState.interval = null;
    }
  });
</script>
